<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="de" xml:lang="de"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Einführung in IoT - E07 MQTT</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./A1_Rasperry_Pi.html" rel="next">
<link href="./E06_Biometrie.html" rel="prev">
<link href="./images/favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "Keine Treffer",
    "search-matching-documents-text": "Treffer",
    "search-copy-link-title": "Link in die Suche kopieren",
    "search-hide-matches-text": "Zusätzliche Treffer verbergen",
    "search-more-match-text": "weitere Treffer in diesem Dokument",
    "search-more-matches-text": "weitere Treffer in diesem Dokument",
    "search-clear-button-title": "Zurücksetzen",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Abbrechen",
    "search-submit-button-title": "Abschicken",
    "search-label": "Suchen"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Seitenleiste umschalten" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./E01_Luftqualitaet.html">Praktika</a></li><li class="breadcrumb-item"><a href="./E07_MQTT.html">E07 MQTT</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Seitenleiste umschalten" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./images/logo.jpg" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Einführung in IoT</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/314a/5200_IoT" title="Quellcode" class="quarto-navigation-tool px-1" aria-label="Quellcode"><i class="bi bi-github"></i></a>
    <a href="./5200_IoT.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Suchen"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Inhalt</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Theorie</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Abschnitt umschalten">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_IoT.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Internet of Things IoT</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_Sensoren.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Sensoren</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_Datenübertragung.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Datenübertragung</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Literatur</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Praktika</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Abschnitt umschalten">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./E01_Luftqualitaet.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">E01 Luftqualitätmessung</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./E02_Spektralmessung.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">E02 Spektralmessung</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./E03_Bewegungsmessung.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">E03 Bewegungsmessung</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./E04_Distanzmessung.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">E04 Distanzmessung</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./E05_Thermalmessung.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">E05 Thermale Aufnahmen</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./E06_Biometrie.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">E06 Biometrie</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./E07_MQTT.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">E07 MQTT</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Anhang</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Abschnitt umschalten">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A1_Rasperry_Pi.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Raspberry Pi</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A2_Sensorbox.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Raspberry Pi Sensorbox</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A3_CheatSheet.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Shell Cheat Sheet</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A4_Setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">Raspberry Pi IoT Image</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Inhaltsverzeichnis</h2>
   
  <ul class="collapse">
  <li><a href="#übungsaufbau" id="toc-übungsaufbau" class="nav-link active" data-scroll-target="#übungsaufbau">Übungsaufbau</a></li>
  <li><a href="#aufgabe-1-mqtt-kennenlernen" id="toc-aufgabe-1-mqtt-kennenlernen" class="nav-link" data-scroll-target="#aufgabe-1-mqtt-kennenlernen">Aufgabe 1: MQTT kennenlernen</a></li>
  <li><a href="#aufgabe-2-mqtt-mit-python-verwenden" id="toc-aufgabe-2-mqtt-mit-python-verwenden" class="nav-link" data-scroll-target="#aufgabe-2-mqtt-mit-python-verwenden">Aufgabe 2: MQTT mit Python verwenden</a></li>
  <li><a href="#aufgabe-3-sensordaten-mit-mqtt-übertragen" id="toc-aufgabe-3-sensordaten-mit-mqtt-übertragen" class="nav-link" data-scroll-target="#aufgabe-3-sensordaten-mit-mqtt-übertragen">Aufgabe 3: Sensordaten mit MQTT übertragen</a></li>
  <li><a href="#aufgabe-4-mqtt-mit-node-red-verwenden" id="toc-aufgabe-4-mqtt-mit-node-red-verwenden" class="nav-link" data-scroll-target="#aufgabe-4-mqtt-mit-node-red-verwenden">Aufgabe 4: MQTT mit Node-RED verwenden</a></li>
  <li><a href="#aufgabe-5-node-red-mqtt-mit-influxdb-verwenden" id="toc-aufgabe-5-node-red-mqtt-mit-influxdb-verwenden" class="nav-link" data-scroll-target="#aufgabe-5-node-red-mqtt-mit-influxdb-verwenden">Aufgabe 5: Node-Red MQTT mit InfluxDB verwenden</a></li>
  <li><a href="#aufgabe-6-influxdb-mit-grafana-verwenden" id="toc-aufgabe-6-influxdb-mit-grafana-verwenden" class="nav-link" data-scroll-target="#aufgabe-6-influxdb-mit-grafana-verwenden">Aufgabe 6: InfluxDB mit Grafana verwenden</a></li>
  <li><a href="#aufgabe-7-influxdb-mit-python-verwenden-optional" id="toc-aufgabe-7-influxdb-mit-python-verwenden-optional" class="nav-link" data-scroll-target="#aufgabe-7-influxdb-mit-python-verwenden-optional">Aufgabe 7: InfluxDB mit Python verwenden (optional)</a></li>
  </ul>
<div class="toc-actions"><ul class="collapse"><li><a href="https://github.com/314a/5200_IoT/edit/master/E07_MQTT.qmd" class="toc-action"><i class="bi bi-github"></i>Seite editieren</a></li><li><a href="https://github.com/314a/5200_IoT/issues/new" class="toc-action"><i class="bi empty"></i>Problem melden</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./E01_Luftqualitaet.html">Praktika</a></li><li class="breadcrumb-item"><a href="./E07_MQTT.html">E07 MQTT</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">E07 MQTT</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Ein IoT Datenfluss erstreckt sich über verschiedene Instanzen, die für die einzelnen Prozesse zuständig sind, von der Erfassung von Sensormesswerten im IoT Gerät über die Kommunikation der Messwerte bis zur Datenverarbeitung, Speicherung und Visualisierung (<a href="#fig-iotpipeline" class="quarto-xref">Abb.&nbsp;<span>1</span></a>). Hierbei können alle Schritte auf einem Gerät durchgeführt werden oder jeder einzelne über ein anderes Gerät oder Server. In der Abbildung aufgezeigt sind typische Softwarekomponenten, die in IoT eingesetzt werden, wie Node-Red für die Datenverarbeitung, die InfluxDB Datenbank, welche für das Speichern von Zeitreihendaten entwickelt wurde und Grafana eine Visualisierungsplattform, die für Messdaten optimiert ist. Es sind Werkzeuge die über ihre graphische Oberfläche einen guten Einstieg ermöglichen, sogenannte <em>low-code</em> Tools, die sich gut eignen für die Entwicklung von Prototypen mit geringem zeitlichen Aufwand. Je nach Anwendung können die einzelnen Prozessschritte auch gut in einer Scriptsprache wie Python durchgeführt oder eine andere Datenbank verwendet werden.</p>
<div id="fig-iotpipeline" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-iotpipeline-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/mqtt-node-red-inffluxdb-grafana.jpg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-iotpipeline-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Abb.&nbsp;1: Typischer IoT Datenfluss und Verarbeitung über diverse Instanzen, von dem IoT Gerät mit Sensorik, Datenkommunikation mit MQTT und dem MQTT Broker, zur Datenprozessierung mit Node-Red, Datenspeicherung und und Visalisierung.
</figcaption>
</figure>
</div>
<p>Ziel dieser Übung ist es MQTT näher kennenzulernen und die MQTT Kommunikation mit dem Raspberry Pi zu testen. MQTT ist ein leichtgewichtiges Kommunikationsprotokoll, welches das <em>Publish-Subscribe</em> Muster verwendet und gut für die Anwendung in IoT Projekten geeignet.</p>
<section id="übungsaufbau" class="level2">
<h2 class="anchored" data-anchor-id="übungsaufbau">Übungsaufbau</h2>
<ul>
<li>Schliesse den Raspberry Pi an Monitor, Keyboard und Maus an oder verbinde Dich mit diesem über SSH (und SFTP).</li>
<li>Erstelle auf dem Raspberry Pi im <code>Documents</code> Ordner einen neuen Ordner <code>mqtt</code>, in welchem Du Änderungen und neue Dateien für diese Übung speichern kannst.</li>
<li>Schliesse den Sensor <strong>BME688</strong> an den Raspberry Pi über die Breakout Garden <strong>I2C</strong> Schnittstelle korrekt an (siehe <a href="./E01_Luftqualitaet.html">E01 Luftqualität</a>), so dass die Beschriftung der Anschlüsse am Sensor und bei der Schnittstelle übereinstimmen.</li>
<li>Kontrolliere mit dem Befehl <code>i2cdetect -y 1</code> ob der Raspberry Pi mit dem Sensor verbunden ist. Der Sensor sollte auf der Adresse <code>0x76</code> erkannt werden.</li>
<li>Kontrolliere, ob die Library <code>sudo pip3 install bme680</code> installiert ist mit <code>python -c "import sudo pip3 install bme680"</code>. Installiere die Library mit <code>sudo pip3 install sudo pip3 install bme680</code> falls sie nicht installiert ist.</li>
<li>Wechsle in den Ordner <em>Documents</em> und erstelle einen Ordner <em>mqtt</em> für diese Übung.</li>
</ul>
</section>
<section id="aufgabe-1-mqtt-kennenlernen" class="level2">
<h2 class="anchored" data-anchor-id="aufgabe-1-mqtt-kennenlernen">Aufgabe 1: MQTT kennenlernen</h2>
<p>Testen ob der <a href="https://mosquitto.org">Mosquitto</a> Broker und Clients lokal auf dem Raspberry Pi funktionieren.</p>
<p><img src="images/mqtt-publish-subscribe.jpg" class="img-fluid"></p>
<p>Erstelle einen Subscriber der für das Topic <code>iot/temperature</code> eine Subscription erstellt.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mosquitto_sub</span> <span class="at">-h</span> 127.0.0.1 <span class="at">-v</span> <span class="at">-t</span> <span class="st">'iot/temperature'</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Öffne ein zweite Shell und erstelle einen Publisher für dasselbe Topic</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mosquitto_pub</span> <span class="at">-h</span> 127.0.0.1 <span class="at">-t</span> <span class="st">'iot/temperature'</span> <span class="at">-m</span> <span class="st">'Aussentemperatur: 22° Celsius'</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="exercise">
<ul>
<li>Teste nun den MQTT mit unterschiedlichen Topics und Nachrichten.</li>
<li>Teste einen weiteren Mosquitto Server auf einem anderen Raspberry Pi und teste die Kommunikation. Hierbei muss die IP Adresse entsprechend angepasst werden.</li>
</ul>
</div>
<p>Falls der Mosquitto Brokers und Clients nicht installiert sind, können diese mit folgenden Befehlen installiert werden.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install mosquitto <span class="at">-y</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install mosquitto-clients <span class="at">-y</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl enable mosquitto.service</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="hint">
<p><a href="https://apps.microsoft.com/detail/9NBLGGH55JZG">MQTTBox</a> und <a href="https://mqtt-explorer.com">MQTT Explorer</a> sind zwei MQTT Clients, die für die Entwicklung und das Testen von MQTT Applikationen verwendet werden können. Jedoch scheinen diese nicht mehr oder eher sporadisch weiterentwickelt zu werden.</p>
</div>
</section>
<section id="aufgabe-2-mqtt-mit-python-verwenden" class="level2">
<h2 class="anchored" data-anchor-id="aufgabe-2-mqtt-mit-python-verwenden">Aufgabe 2: MQTT mit Python verwenden</h2>
<p>Nun verwenden wir die Bibliothek <code>paho-mqtt</code> in Python um MQTT zu verwenden. Folgende zwei Code Snippets zeigen wie ein Publisher und Subscriber in Python implementiert werden können.</p>
<p><img src="images/mqtt-sensor-subscribe.jpg" class="img-fluid"></p>
<p><strong>Script 1:</strong> <code>mqtt_sub.py</code> - Subscriber</p>
<div class="sourceCode" id="annotated-cell-4"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-4-1"><a href="#annotated-cell-4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> paho.mqtt.client <span class="im">as</span> mqtt </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-4-2" class="code-annotation-target"><a href="#annotated-cell-4-2" aria-hidden="true" tabindex="-1"></a>ip <span class="op">=</span> <span class="st">"127.0.0.1"</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-4-3" class="code-annotation-target"><a href="#annotated-cell-4-3" aria-hidden="true" tabindex="-1"></a>topic <span class="op">=</span> <span class="st">"iot/temperature"</span></span>
<span id="annotated-cell-4-4"><a href="#annotated-cell-4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-4-5"><a href="#annotated-cell-4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Callback Funktion für den Verbindungsaufbau</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-4-6" class="code-annotation-target"><a href="#annotated-cell-4-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> on_connect(client, userdata, flags, rc):</span>
<span id="annotated-cell-4-7"><a href="#annotated-cell-4-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Connected - code: "</span><span class="op">+</span><span class="bu">str</span>(rc)) </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-4-8" class="code-annotation-target"><a href="#annotated-cell-4-8" aria-hidden="true" tabindex="-1"></a>    client.subscribe(topic)</span>
<span id="annotated-cell-4-9"><a href="#annotated-cell-4-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-4-10"><a href="#annotated-cell-4-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Callback Funktion für eingehende Nachrichten</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-4-11" class="code-annotation-target"><a href="#annotated-cell-4-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> on_message(client, userdata, msg):</span>
<span id="annotated-cell-4-12"><a href="#annotated-cell-4-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(msg.topic<span class="op">+</span><span class="st">" "</span><span class="op">+</span><span class="bu">str</span>(msg.payload))</span>
<span id="annotated-cell-4-13"><a href="#annotated-cell-4-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-4-14"><a href="#annotated-cell-4-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Erstellen des MQTT Clients</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-4-15" class="code-annotation-target"><a href="#annotated-cell-4-15" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> mqtt.Client()</span>
<span id="annotated-cell-4-16"><a href="#annotated-cell-4-16" aria-hidden="true" tabindex="-1"></a>client.on_connect <span class="op">=</span> on_connect</span>
<span id="annotated-cell-4-17"><a href="#annotated-cell-4-17" aria-hidden="true" tabindex="-1"></a>client.on_message <span class="op">=</span> on_message</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="7" onclick="event.preventDefault();">7</a><span id="annotated-cell-4-18" class="code-annotation-target"><a href="#annotated-cell-4-18" aria-hidden="true" tabindex="-1"></a>client.<span class="ex">connect</span>(ip, <span class="dv">1883</span>, <span class="dv">60</span>)</span>
<span id="annotated-cell-4-19"><a href="#annotated-cell-4-19" aria-hidden="true" tabindex="-1"></a>client.loop_forever()</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-4" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="2" data-code-annotation="1">IP Adresse des MQTT Brokers</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="3" data-code-annotation="2">Topic auf welches der Subscriber hört</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="6" data-code-annotation="3">Callback Funktion on_connect wird ausgeführt, wenn die Verbidnung steht</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="8" data-code-annotation="4">Subscription für das Topic</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="11,12" data-code-annotation="5">Callback Funktion on_publish wird ausgeführt, wenn eine Nachricht empfangen (publish) wird</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="15,16,17" data-code-annotation="6">Erstellen eines MQTT Clients und Zuweisung der Callback Funktionen</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="18,19" data-code-annotation="7">Verbindung zum MQTT Broker herstellen und auf eingehende Nachrichten warten (loop_forever)</span>
</dd>
</dl>
<p><strong>Script 2: </strong><code>mqtt_pub.py</code> - Publisher</p>
<div class="sourceCode" id="annotated-cell-5"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-5-1"><a href="#annotated-cell-5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> paho.mqtt.publish <span class="im">as</span> publish </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-5-2" class="code-annotation-target"><a href="#annotated-cell-5-2" aria-hidden="true" tabindex="-1"></a>ip <span class="op">=</span> <span class="st">"127.0.0.1"</span></span>
<span id="annotated-cell-5-3"><a href="#annotated-cell-5-3" aria-hidden="true" tabindex="-1"></a>topic <span class="op">=</span> <span class="st">"iot/temperature"</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-5-4" class="code-annotation-target"><a href="#annotated-cell-5-4" aria-hidden="true" tabindex="-1"></a>publish.single(topic, <span class="st">"22.0"</span>, hostname<span class="op">=</span>ip, port<span class="op">=</span><span class="dv">1883</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-5" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="2,3" data-code-annotation="1">IP Adresse des MQTT Brokers und Topic definieren</span>
</dd>
<dt data-target-cell="annotated-cell-5" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="4" data-code-annotation="2">Nachricht mit Topic an den MQTT Broker (ip,port) senden</span>
</dd>
</dl>
<div class="exercise">
<ul>
<li>Speichere die beiden Dateien <code>mqtt_pub.py</code> und <code>mqtt_sub.py</code> im Ordner <code>mqtt</code> ab.</li>
<li>(Optional: Passe die IP Adresse des MQTT Brokers an, falls ein anderer MQTT Broker genutzt werden soll.)</li>
<li>Öffne zwei Terminals und führe diese mit <code>python3 mqtt_pub.py</code> und <code>python3 mqtt_sub.py</code> aus.</li>
</ul>
</div>
<p>Falls die Library paho-mqtt nicht installiert ist, kann diese mit <code>sudo pip3 install paho-mqtt</code> installiert werden.</p>
</section>
<section id="aufgabe-3-sensordaten-mit-mqtt-übertragen" class="level2">
<h2 class="anchored" data-anchor-id="aufgabe-3-sensordaten-mit-mqtt-übertragen">Aufgabe 3: Sensordaten mit MQTT übertragen</h2>
<p>Passe nun das Script <code>mqtt_pub.py</code> an, so dass die Temperatur vom Sensor <code>BME688</code> ausgelesen und über MQTT übertragen wird. Die Temperatur soll alle 10 Sekunden übertragen werden. Nutze hierfür das Script zum Auslesen der Sensordaten aus der Übung <a href="./E01_Luftqualitaet.html">E01 Luftqualität</a> und passe dieses an.</p>
<div class="exercise">
<ul>
<li>Speichere das <code>mqtt_pub.py</code> als <code>mqtt_pub_bme688.py</code> im Ordner <code>mqtt</code> ab.</li>
<li>Ergänze das Script um die Funktionen zum auslesen der Temperatur des BME688 Sensors.</li>
<li>Ergänze das Script für das Auslesen der Luftfeuchtigkeit und Luftdruck und ergänze die topics mit <code>iot/humidity</code> und <code>iot/pressure</code>.</li>
<li>Erweitere das Script <code>mqtt_sub.py</code> um die Subscription für die Topics <code>iot/humidity</code> und <code>iot/pressure</code> und speichere es als <code>mqtt_sub_bme688.py</code> ab.</li>
<li>Öffne zwei Terminals und führe diese mit <code>python3 mqtt_pub_bme688.py</code> und <code>python3 mqtt_sub_bme688.py</code> aus.</li>
</ul>
</div>
</section>
<section id="aufgabe-4-mqtt-mit-node-red-verwenden" class="level2">
<h2 class="anchored" data-anchor-id="aufgabe-4-mqtt-mit-node-red-verwenden">Aufgabe 4: MQTT mit Node-RED verwenden</h2>
<p>Node-Red ist ein grafisches Entwicklungswerkzeug für IoT, ein low-code Tool für <em>event-driven applications</em>. Es bietet eine browserbasierte und datenstromorientierte “Flow” Programmierung für die Verarbeitung von Sensordaten (ähnlich wie FME oder graphische Modellierungswerkzeuge in GIS). Die Implementation von Node-Red ist in JavaScript und basiert auf node.js. Datenverarbeitungsflows können gespeichert und wiederverwendet werden. Im Arbeitsbereich (<a href="#fig-noderedmqttflow" class="quarto-xref">Abb.&nbsp;<span>2</span></a>) können sogenannte Nodes, die unterschiedliche Funktionen erfüllen, zu einem Daten-“Flow” werden. Nodes können auch selbst erstellt werden. Es gibt eine Vielzahl von Nodes, die von der Community entwickelt wurden, die über den Node-Red Palette Manager installiert werden können. Core Nodes von Node-Red sind:</p>
<ul>
<li><strong>Inject Node</strong>: Kann einen Flow über den Button direkt auslösen oder in regelmässigen Abständen mit Zeitstempel oder vordefinierten Nachrichten (msg) senden.</li>
<li><strong>Debug Node</strong>: Kann die <a href="https://nodered.org/docs/user-guide/messages">Nachrichten</a> (msg) in Debug Sidebar anzeigen lassen.</li>
<li><strong>Function Node</strong>: Kann mit JavaScript <a href="https://nodered.org/docs/user-guide/writing-functions">Funktionen</a> den Inhalt der Nachrichten (msg) verändern.</li>
<li><strong>Change Node</strong>: Ermöglicht das Ändern von Eigenschaften einer Nachricht (ohne den Funktion Node zu nützen) um beispielsweise Eigenschaften zu setzen, ändern oder löschen.</li>
<li><strong>Switch Node</strong>: Kann Nachrichten (msg) anhand von Regeln auswerten in verschiedene Ausgänge leiten (wie ein Switch Case in der Programmierung).</li>
<li><strong>Template Node</strong>: Kann über Eigenschaften einer Nachricht und einer Vorlage (Template) neue Nachricht nach Vorlage erstellen: <code>Nachricht: {{payload}}!</code> wird <code>Nachricht: 1570439577309 !</code>.</li>
</ul>
<p>Node-Red kann über den Browser auf dem Raspberry Pi oder via Laptop gestartet werden. Öffne den Browser und gebe die IP Adresse des Raspberry Pi mit dem Port 1880 ein: <code>http://&lt;ip-adresse&gt;:1880</code>. Führt nun das Kurztutorial zu Node-Red aus: <a href="https://nodered.org/docs/getting-started/first-flow">Node-Red Getting Started: First Flow</a>. In diesem Tutorial wird ein Flow erstellt, der eine Nachricht mit einem Zeitstempel ausgibt.</p>
<div id="fig-noderedmqttflow" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-noderedmqttflow-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/node-red_mqtt_flow.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-noderedmqttflow-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Abb.&nbsp;2: Node-Red Flow der Daten in das Topic <em>iot/temperature</em> published, und Nachrichten aus dem Topic <em>iot/temperature</em> subscribed.
</figcaption>
</figure>
</div>
<div class="exercise">
<p>Erstelle einen Flow der Nachrichten an den MQTT Broker senden und Nachrichten vom MQTT Broker empfangen kann.</p>
<ol type="1">
<li>Füge hierfür einen Inject Node, einen Debug Node und einen MQTT Output Node hinzu. Öffne die Einstellungen des MQTT Output Nodes (siehe <a href="#fig-noderedmqttnodesetup" class="quarto-xref">Abb.&nbsp;<span>3</span></a>) und setze die IP Adresse des MQTT Brokers und das Topic auf <code>iot/temperature</code>. Starte den Flow und überprüfe, ob die Nachrichten an den MQTT Broker gesendet werden.</li>
<li>Erstelle nun einen weiteren Flow, der die Nachrichten vom MQTT Broker empfängt und in der Debug Sidebar anzeigt. Füge hierfür einen MQTT Input Node (siehe <a href="#fig-noderedmqttnodesetup" class="quarto-xref">Abb.&nbsp;<span>3</span></a>) und einen Debug Node hinzu. Öffne die Einstellungen des MQTT Input Nodes und setze die IP Adresse des MQTT Brokers und das Topic auf <code>iot/temperature</code>. Starte den Flow und überprüfe, ob die Nachrichten vom MQTT Broker empfangen werden.</li>
<li>Ergänze den Flow um einen MQTT Input Node für die Topics <code>iot/humidity</code> und <code>iot/pressure</code> und je einen Debug Node. Starte den Flow und überprüfe, ob die Nachrichten vom MQTT Broker empfangen werden.</li>
</ol>
</div>
<div id="fig-noderedmqttnodesetup" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-noderedmqttnodesetup-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/node-red_mqtt_setup.jpg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-noderedmqttnodesetup-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Abb.&nbsp;3: Node-Red MQTT Node Einstellungen setzen, (1) Name angeben, (2) Server Einstellungen öffnen und (3) IP Adresse des MQTT Brokers setzen, (4) subscribe to single topic wählen und (5) Topic <code>iot/temperature</code> setzen.
</figcaption>
</figure>
</div>
<div class="hint">
<p>Flows stoppen: Um einen Flow in der Ausführung zu stoppen, kann dieser über den Tab (rechte Maustaste) Flow deaktiviert werden (disable flow) und mit einem erneuten Übernehmen (Deploy) wird der Flow gestoppt.</p>
</div>
</section>
<section id="aufgabe-5-node-red-mqtt-mit-influxdb-verwenden" class="level2">
<h2 class="anchored" data-anchor-id="aufgabe-5-node-red-mqtt-mit-influxdb-verwenden">Aufgabe 5: Node-Red MQTT mit InfluxDB verwenden</h2>
<p>InfluxDB ist die Datenbank, die für die Erfassung, Speicherung, Verarbeitung und Visualisierung von Zeitreihendaten entwickelt wurde. Zeitreihendaten sind Datenpunkt, die in zeitlicher Sequenz erfasst wurden und bestehen in der Regele aus aufeinanderfolgenden Messungen aus derselben Quelle, wie beispielsweise die Temperaturdaten des BME688. InfluxDB organisiert die Zeitreihendaten in Buckets (anstatt Datenbanken) und Messungen. Ein Bucket kann mehrere Messungen enthalten, wobei Messungen Felder und Tags enthalten können <span class="citation" data-cites="influxdata2023">(<a href="references.html#ref-influxdata2023" role="doc-biblioref">influxdata 2023</a>)</span>. Eine Messung ist enthält Felder mit key-value Paaren von Messwerten, die sich über die Zeit ändern. Tags sind key-value Paare, die sich nicht über die Zeit ändern und für die Filterung und Gruppierung verwendet werden können.</p>
<p>Das Tutorial <a href="https://docs.influxdata.com/influxdb/v2/get-started/">Getting Started</a> zeigt die ersten Schritte mit InfluxDB.</p>
<p><img src="images/mqtt-sensor-broker-influxdb.jpg" class="img-fluid"></p>
<p>Die graphische Oberfläche von InfluxDB kann über den Browser auf dem Raspberry Pi oder via Laptop gestartet werden.</p>
<p>Öffnet nun den Browser und gebe die IP Adresse des Raspberry Pi mit dem Port 8086 ein: <code>http://&lt;ip-adresse&gt;:8086</code>. Erstellt über die linke Menuleiste unter <em>Load Data</em> einen neuen Bucket mit dem Namen <code>iot</code>, falls dieser nicht schon existiert. Kopiert unter <em>load Data / API Tokens</em> den Token für den Zugang zur Datenbank.</p>
<p>Diese Angaben (<em>bucket</em> und <em>API Token</em>) werden für den InfluxDB Node in Node-Red benötigt. Die Einstellungen des InfluxDB Node benötigen die Angaben, wohin die Daten in der Datenbank gespeichert werden (links in <a href="#fig-noderedinfluxdb" class="quarto-xref">Abb.&nbsp;<span>4</span></a>) mit Angaben zum Bucket (Datenbankname), Organisation<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> und measurement und die Serververbindung (rechts in <a href="#fig-noderedinfluxdb" class="quarto-xref">Abb.&nbsp;<span>4</span></a>) mit der IP Adresse und das Token für den Zugang zur Datenbank.</p>
<div class="hint">
<p>Falls keine Nodes für InfluxDB in Node-Red vorhanden sind, kann die Erweiterung <code>node-red-contrib-influxdb</code> über das Hauptmenu <em>Palette verwalten</em> im Tab <em>Installation</em> installiert werden.</p>
</div>
<div id="fig-noderedinfluxdb" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-noderedinfluxdb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/node-red_influxdb_setup.jpg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-noderedinfluxdb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Abb.&nbsp;4: Einstellungen der InflxDB Nodes in Node-Red, links: Einstellungen zur Datenbank (1) mit Angaben zur Organisation (5), Bucket (6) und Namen der Messung <em>measurement</em> (7), rechts: Einstellungen zur Datenbankverbindung (2) mit der URL und Port der InfluxDB (3) und dem API Token (4), für den Zugang zur Datenbank.
</figcaption>
</figure>
</div>
<p>Die Messwerte können direkt in die InfluxDB geschrieben werden, jedoch fehlen da noch die Tags, die für die Filterung und Gruppierung verwendet werden können. Diese können über den Change Node hinzugefügt werden, wie in <a href="#fig-noderedpayload" class="quarto-xref">Abb.&nbsp;<span>5</span></a> gezeigt. Hierbei wird der Wert der Payload in ein Feld mit dem Namen <em>temperature</em> geschrieben und die Tags <em>device</em> und <em>sensor</em> werden hinzugefügt. Dieselbe Struktur kann alternativ auch mit dem Function Node erstellt werden, siehe <a href="#fig-noderedpayload" class="quarto-xref">Abb.&nbsp;<span>5</span></a> rechts. Hierbei wird der Wert der Payload in ein Feld mit dem Namen <em>temperature</em> geschrieben und die Tags <em>device</em> und <em>sensor</em> werden hinzugefügt. Die Bezeichnung der Messung <em>temperature</em> wird im InfluxDB Node definiert oder kann im Function Node überschrieben werden.</p>
<div id="fig-noderedpayload" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-noderedpayload-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/node-red_influxdb_change_function_node.jpg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-noderedpayload-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Abb.&nbsp;5: Über den Change Node, wie auch den Function Node kann mit JavaScript der Inhalt der Payload verändert werden und diesen für den Import in die InfluxDB angepasst werden.
</figcaption>
</figure>
</div>
<div class="sourceCode" id="annotated-cell-6"><pre class="sourceCode javascript code-annotation-code code-with-copy code-annotated"><code class="sourceCode javascript"><span id="annotated-cell-6-1"><a href="#annotated-cell-6-1" aria-hidden="true" tabindex="-1"></a>msg<span class="op">.</span><span class="at">payload</span> <span class="op">=</span> [{ </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-6-2" class="code-annotation-target"><a href="#annotated-cell-6-2" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="dt">temperature</span><span class="op">:</span>msg<span class="op">.</span><span class="at">payload</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-6-3" class="code-annotation-target"><a href="#annotated-cell-6-3" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> { <span class="dt">device</span><span class="op">:</span><span class="st">"RPI_01"</span><span class="op">,</span><span class="dt">&nbsp;sensor</span><span class="op">:</span><span class="st">"BME688"</span> }]<span class="op">;</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-6-4" class="code-annotation-target"><a href="#annotated-cell-6-4" aria-hidden="true" tabindex="-1"></a>msg<span class="op">.</span><span class="at">measurement</span><span class="op">=</span><span class="st">"temperature"</span><span class="op">;</span></span>
<span id="annotated-cell-6-5"><a href="#annotated-cell-6-5" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> msg<span class="op">;</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-6" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="2" data-code-annotation="1">Werte der Payload in Payloadstruktur für die InfluxDB schreiben</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="3" data-code-annotation="2">Tags der Messung zuweisen</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="4" data-code-annotation="3">Optional <em>measurement</em> kann im InfluxDB Node oder im Funktionsknoten definiert werden</span>
</dd>
</dl>
<p>InfluxDB bietet über das Menu <em>Data Explorer</em> eine einfache Möglichkeit die Daten zu visualisieren. Der Query Builder (<a href="#fig-influxdbdataexplorer" class="quarto-xref">Abb.&nbsp;<span>6</span></a>) hilft bei der Erstellung von Abfragen mit der über die Fields und Tags gefiltert werden kann, die dann über den Button <em>Submit</em> ausgeführt und dargestellt werden können. Die erstellte Query kann über den <em>Script Editor</em> (<a href="#fig-influxdbdataexplorer" class="quarto-xref">Abb.&nbsp;<span>6</span></a>) angezeigt werden.</p>
<div id="fig-influxdbdataexplorer" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-influxdbdataexplorer-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/influxdb_data_explorer.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-influxdbdataexplorer-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Abb.&nbsp;6: Über den <em>Data Explorer</em> können in InfluxDB einfach Abfragen zusammengestellt und über <em>submit</em> visualisiert werden
</figcaption>
</figure>
</div>
<div class="exercise">
<ul>
<li>Erstellt nun einen Flow der die Nachrichten des Topics <code>iot/temperature</code> vom MQTT Broker empfängt und in die InfluxDB schreibt.</li>
<li>Erstellt erst einen flow der nur die Nachrichten ohne Tags in die InfluxDB schreibt</li>
<li>Ergänzt den Flow mit einem Change oder Function Node um die Tags <em>device</em> und <em>sensor</em> hinzuzufügen.</li>
<li>Visualisiert den Temperaturverlauf des BME688 in der InfluxDB mit dem <em>Data Explorer</em> und studiert die Flux Abfragesprache.</li>
<li>Erstellt einen Flow der die Nachrichten der Topics <code>iot/humidity</code> und <code>iot/pressure</code> vom MQTT Broker empfängt und in die InfluxDB schreibt.</li>
<li>(Optional) erstellt im Menu <em>Dashboard</em> eine Visualisierung der Messwerte.</li>
</ul>
</div>
</section>
<section id="aufgabe-6-influxdb-mit-grafana-verwenden" class="level2">
<h2 class="anchored" data-anchor-id="aufgabe-6-influxdb-mit-grafana-verwenden">Aufgabe 6: InfluxDB mit Grafana verwenden</h2>
<p>Grafana ist eine Open-Source Anwendung für die Darstellung von Daten aus den unterschiedlichsten Messquellen, wie Postgres, SQLite oder InfluxDB. In dieser Übung wird Grafana mit der InfluxDB Datenbank verwendet.</p>
<p>Öffnet nun den Browser und gebt die IP Adresse des Raspberry Pi mit dem Port 3000 ein: <code>http://&lt;ip-adresse&gt;:3000</code>. Unter Connections / Data Sources können Grafana Datenquellen hinzugefügt werden, wählt nun <em>InfluxDB</em> um Grafana mit der InfluxDB zu verbinden. Setzt folgende Einstellungen (<a href="#fig-grafanainfluxdb" class="quarto-xref">Abb.&nbsp;<span>7</span></a>) und speichert diese:</p>
<ul>
<li><em>Query Language</em>: Wählt in den Einstellungen zu <em>Query Language</em> die Abfragesprache <code>Flux</code>.</li>
<li><em>HTTP</em>: Setzt die IP Adresse des Raspberry Pi und den Port 8086: <code>http://localhost:8086</code>.</li>
<li><em>Auth</em>: aktiviert <em>Basic Auth</em></li>
<li><em>Basic Auth Details</em>: Setzt den InfluxDB Benutzer und das Passwort für die InfluxDB</li>
<li><em>InfluxDB Details</em>: Setzt die InfluxDB Organisation <em>fhnw</em>, den <em>API Token</em>, und den InfluxDB Bucket <em>iot</em>.</li>
</ul>
<div id="fig-grafanainfluxdb" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-grafanainfluxdb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/mqtt_grafana_influxdb_settings.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-grafanainfluxdb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Abb.&nbsp;7: InfluxDB als Datenquelle in Grafana hinzufügen mit den entsprechenden Angaben.
</figcaption>
</figure>
</div>
<p>Ist die Verbindung erstellt, können neue Dashboards erstellt werden. Die Queries, die für die Visualisierung verwendet werden sollen, können über den <em>Query Builder</em> in InfluxDB erstellt und in Grafana beim Erstellen der Panels (<a href="#fig-grafanainfluxdbquery" class="quarto-xref">Abb.&nbsp;<span>8</span></a>) reinkopiert werden.</p>
<div id="fig-grafanainfluxdbquery" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-grafanainfluxdbquery-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/mqtt_grafana_influxdb_query.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-grafanainfluxdbquery-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Abb.&nbsp;8: Flux Queries der Datenabfragen im Data Explorer können in Grafana für die Visualisierung kopiert und genutzt werden.
</figcaption>
</figure>
</div>
<div class="exercise">
<ul>
<li>Erstellt eine Verbindung zwischen Grafana und der InfluxDB.</li>
<li>Erstellt ein Dashboard mit einer Visualisierung der Temperatur, Luftfeuchtigkeit und Luftdruck des BME688 Sensors.</li>
</ul>
</div>
</section>
<section id="aufgabe-7-influxdb-mit-python-verwenden-optional" class="level2">
<h2 class="anchored" data-anchor-id="aufgabe-7-influxdb-mit-python-verwenden-optional">Aufgabe 7: InfluxDB mit Python verwenden (optional)</h2>
<p>Anstatt mit Node-Red können die Daten des Sensors direkt in die InfluxDB geschrieben werden. Folgender Code zeigt wie die Daten des BME688 Sensors mit Python ausgelesen und in die InfluxDB geschrieben werden können. Teste erst, ob der <code>influxdb-client</code> installiert ist und installiere diesen falls nicht mit dem Befehl <code>pip3 install influxdb-client</code>. Folgendes Tutorial zeigt wie die Daten mit Python in die InfluxDB geschrieben werden können: <a href="https://www.influxdata.com/blog/getting-started-with-python-and-influxdb-v2-0/">Getting Started with Python and InfluxDB v2.0</a>.</p>
<p><img src="images/mqtt-sensor-influxdb.jpg" class="img-fluid"></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> influxdb_client <span class="im">import</span> InfluxDBClient, Point, WritePrecision</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> influxdb_client.client.write_api <span class="im">import</span> SYNCHRONOUS</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Generieren ein Token in der InfluxDB UI unter dem Tab "Data / Tokens Tab"</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>token <span class="op">=</span> <span class="st">"&lt;influxdb-token&gt;"</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>org <span class="op">=</span> <span class="st">"fhnw"</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>bucket <span class="op">=</span> <span class="st">"iot"</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> InfluxDBClient(url<span class="op">=</span><span class="st">"http://localhost:8086"</span>, token<span class="op">=</span> token, org<span class="op">=</span> org)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>write_api <span class="op">=</span> client.write_api(write_options <span class="op">=</span> SYNCHRONOUS)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>temperature <span class="op">=</span> <span class="fl">22.0</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> Point(<span class="st">"measures"</span>).tag(<span class="st">"fields"</span>, <span class="dv">2</span>).field(<span class="st">"temperature"</span>, temperature)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>write_api.write(bucket <span class="op">=</span> bucket, record <span class="op">=</span> data)</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="exercise">
<p>Schreibe nun mit Hilfe des Tutorials und dem Beispielcode ein Python Script, welches die Temperatur, Luftfeuchtigkeit und Luftdruck des BME688 Sensors ausliest und in die InfluxDB schreibt.</p>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-influxdata2023" class="csl-entry" role="listitem">
influxdata, 2023. <a href="https://docs.influxdata.com/influxdb/v2/get-started/">Get Started with <span>InfluxDB</span> <span></span> <span>InfluxDB OSS</span> v2 <span>Documentation</span></a>.
</div>
</div>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>wird bei der Erstellung der Datenbank definiert<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Kopiert");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Kopiert");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./E06_Biometrie.html" class="pagination-link" aria-label="E06 Biometrie">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">E06 Biometrie</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./A1_Rasperry_Pi.html" class="pagination-link" aria-label="Raspberry Pi\index{Raspberry Pi}">
        <span class="nav-page-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Raspberry Pi</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><img src="images/fhnw_white.png" class="img-fluid"></p>
</div>   
    <div class="nav-footer-center">
<p>Einführung in IoT © 2024 von Pia Bereuter ist lizenziert unter <a href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0</a></p>
<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/314a/5200_IoT/edit/master/E07_MQTT.qmd" class="toc-action"><i class="bi bi-github"></i>Seite editieren</a></li><li><a href="https://github.com/314a/5200_IoT/issues/new" class="toc-action"><i class="bi empty"></i>Problem melden</a></li></ul></div></div>
    <div class="nav-footer-right">
<p>Institut Geomatik, Fachhochschule Nordwestschweiz</p>
</div>
  </div>
</footer>




</body></html>